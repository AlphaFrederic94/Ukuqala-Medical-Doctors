<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WebRTC Call Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; background: #0f172a; color: #e2e8f0; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    input { width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #334155; background: #0b1224; color: #e2e8f0; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; background: #2563eb; color: #fff; margin-right: 8px; }
    video { width: 100%; max-width: 480px; border-radius: 12px; background: #000; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .log { font-size: 12px; white-space: pre-wrap; background: #0b1224; padding: 8px; border-radius: 8px; border: 1px solid #1f2937; max-height: 160px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="card">
    <h3>WebRTC Call Test</h3>
    <input id="token" placeholder="Bearer token (doctor/patient JWT)" />
    <input id="room" value="test-room" placeholder="Room id (e.g., doctorId:patientId)" />
    <div>
      <button id="join">Join room</button>
      <button id="call">Start call</button>
      <button id="hangup">Hangup</button>
    </div>
  </div>
  <div class="row">
    <div class="card" style="flex:1">
      <p>Local</p>
      <video id="local" autoplay playsinline muted></video>
    </div>
    <div class="card" style="flex:1">
      <p>Remote</p>
      <video id="remote" autoplay playsinline></video>
    </div>
  </div>
  <div class="card">
    <p>Log</p>
    <div id="log" class="log"></div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const logEl = document.getElementById("log");
    const localVideo = document.getElementById("local");
    const remoteVideo = document.getElementById("remote");
    const roomInput = document.getElementById("room");
    const tokenInput = document.getElementById("token");

    function log(msg) { console.log(msg); logEl.textContent += msg + "\\n"; logEl.scrollTop = logEl.scrollHeight; }

    const iceServers = [
      { urls: [ 'stun:stun.l.google.com:19302' ] },
      {
        urls: [
          'turn:relay1.expressturn.com:3480?transport=udp',
          'turn:relay1.expressturn.com:3480?transport=tcp',
        ],
        username: 'efPU52K4SLOQ34W2QY',
        credential: '1TJPNFxHKXrZfelz',
      },
    ];

    let pc = null;
    let socket = null;
    let room = null;

    function createPeer() {
      pc = new RTCPeerConnection({ iceServers });
      pc.ontrack = (e) => { remoteVideo.srcObject = e.streams[0]; };
      pc.onicecandidate = (e) => {
        if (e.candidate && room) socket.emit('ice-candidate', { room, candidate: e.candidate });
      };
      pc.onconnectionstatechange = () => log(`PC state: ${pc.connectionState}`);
      return pc;
    }

    async function ensureMedia() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
      stream.getTracks().forEach((t) => pc.addTrack(t, stream));
      localVideo.srcObject = stream;
    }

    function ensureSocket() {
      if (socket) { socket.disconnect(); }
      const token = tokenInput.value.trim();
      socket = io({ auth: { token } });
      socket.on('connect', () => log('socket connected'));
      socket.on('joined', (payload) => log('joined room ' + payload.room));
      socket.on('call-offer', async ({ offer }) => {
        log('got offer');
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        await ensureMedia();
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit('call-answer', { room, answer });
      });
      socket.on('call-answer', async ({ answer }) => {
        log('got answer');
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
      });
      socket.on('ice-candidate', async ({ candidate }) => {
        try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch (e) { log('ice err ' + e); }
      });
      socket.on('call-end', () => {
        log('call ended');
        if (pc) { pc.getSenders().forEach((s)=>s.track&&s.track.stop()); pc.close(); pc=null; }
        pc = createPeer();
      });
    }

    document.getElementById('join').onclick = () => {
      room = roomInput.value || 'test-room';
      ensureSocket();
      pc = createPeer();
      socket.emit('join', { room });
      log('joining ' + room);
    };

    document.getElementById('call').onclick = async () => {
      if (!pc) pc = createPeer();
      await ensureMedia();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit('call-offer', { room, offer });
      log('sent offer');
    };

    document.getElementById('hangup').onclick = () => {
      if (pc) { pc.getSenders().forEach((s)=>s.track&&s.track.stop()); pc.close(); pc=null; }
      socket?.emit('call-end', { room });
      log('hangup');
    };
  </script>
</body>
</html>
